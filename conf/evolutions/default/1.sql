# Create base scheme

# --- !Ups

CREATE TABLE IF NOT EXISTS "USER_INFOS" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
    "EMAIL" VARCHAR NOT NULL,
    "FAMILY_NAME" VARCHAR NOT NULL,
    "GIVEN_NAME" VARCHAR NOT NULL,
    "FULL_NAME" VARCHAR NOT NULL,
    "NICKNAME" VARCHAR NOT NULL,
    "PICTURE" VARCHAR NOT NULL,
    "LOCALE" VARCHAR NOT NULL
);

CREATE UNIQUE INDEX IF NOT EXISTS "USER_INFOS_EMAIL" ON "USER_INFOS" ("EMAIL");

CREATE TABLE IF NOT EXISTS "EVENT_INFOS" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
    "EVENT_TYPE" INTEGER NOT NULL,
    "TITLE" VARCHAR NOT NULL,
    "DESCRIPTION" VARCHAR NOT NULL,
    "USER_INFO_ID_OR_NONE" BIGINT,
    "PUBLISH_DATE_UNIX_MILLIS" BIGINT NOT NULL,
    "STATUS" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "EVENT_INFOS_TITLE" ON "EVENT_INFOS" ("TITLE");

CREATE TABLE IF NOT EXISTS "EVENT_REACTION_TYPES" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
    "TEXT" VARCHAR NOT NULL
);

CREATE TABLE IF NOT EXISTS "EVENT_REACTIONS" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
    "USER_INFO_ID" BIGINT NOT NULL,
    "EVENT_INFO_ID" BIGINT NOT NULL,
    "EVENT_REACTION_TYPE_ID" BIGINT NOT NULL,
    CONSTRAINT "EVENT_REACTIONS_EVENT_INFO" FOREIGN KEY("EVENT_INFO_ID") REFERENCES "EVENT_INFOS"("ID") ON UPDATE NO ACTION ON DELETE NO ACTION,
    CONSTRAINT "EVENT_REACTIONS_EVENT_REACTION_TYPE" FOREIGN KEY("EVENT_REACTION_TYPE_ID") REFERENCES "EVENT_REACTION_TYPES"("ID") ON UPDATE NO ACTION ON DELETE NO ACTION,
    CONSTRAINT "EVENT_REACTIONS_USER_INFO" FOREIGN KEY("USER_INFO_ID") REFERENCES "USER_INFOS"("ID") ON UPDATE NO ACTION ON DELETE NO ACTION
);

CREATE UNIQUE INDEX IF NOT EXISTS "EVENT_REACTIONS_USER_INFO-EVENT_INFO-EVENT_REACTION_TYPE" ON "EVENT_REACTIONS" (
    "USER_INFO_ID",
    "EVENT_INFO_ID",
    "EVENT_REACTION_TYPE_ID"
);

CREATE TABLE IF NOT EXISTS "EVENT_TAGS" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
    "TEXT" VARCHAR NOT NULL
);

CREATE TABLE IF NOT EXISTS "EVENT_TAG_RELATIONS" (
    "EVENT_INFO_ID" BIGINT NOT NULL,
    "EVENT_TAG_ID" BIGINT NOT NULL,
    CONSTRAINT "EVENT_TAG_RELATIONS_PK" PRIMARY KEY("EVENT_INFO_ID", "EVENT_TAG_ID"),
    CONSTRAINT "EVENT_TAG_RELATIONS_EVENT_INFO" FOREIGN KEY("EVENT_INFO_ID") REFERENCES "EVENT_INFOS"("ID") ON UPDATE NO ACTION ON DELETE NO ACTION,
    CONSTRAINT "EVENT_TAG_RELATIONS_EVENT_TAG" FOREIGN KEY("EVENT_TAG_ID") REFERENCES "EVENT_TAGS"("ID") ON UPDATE NO ACTION ON DELETE NO ACTION
);

INSERT INTO EVENT_REACTION_TYPES VALUES (NULL, '聞きたい！')

# --- !Downs

ALTER TABLE "EVENT_REACTIONS" DROP CONSTRAINT "EVENT_REACTIONS_EVENT_INFO";

ALTER TABLE "EVENT_REACTIONS" DROP CONSTRAINT "EVENT_REACTIONS_EVENT_REACTION_TYPE";

ALTER TABLE "EVENT_REACTIONS" DROP CONSTRAINT "EVENT_REACTIONS_USER_INFO";

ALTER TABLE "EVENT_TAG_RELATIONS" DROP CONSTRAINT "EVENT_TAG_RELATIONS_PK";

ALTER TABLE "EVENT_TAG_RELATIONS" DROP CONSTRAINT "EVENT_TAG_RELATIONS_EVENT_INFO";

ALTER TABLE "EVENT_TAG_RELATIONS" DROP CONSTRAINT "EVENT_TAG_RELATIONS_EVENT_TAG";

DROP TABLE "USER_INFOS";

DROP TABLE "EVENT_INFOS";

DROP TABLE "EVENT_REACTION_TYPES";

DROP TABLE "EVENT_REACTIONS";

DROP TABLE "EVENT_TAGS";

DROP TABLE "EVENT_TAG_RELATIONS";
